<!DOCTYPE html>
<html lang="zh-TW">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ÈõÜÈªûË∂£</title>

    <!-- Favicon -->
    <link
      rel="icon"
      type="image/svg+xml"
      href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Cpath fill='%23475569' d='M312 201.8c0-17.4 9.2-33.2 19.9-47C344.5 138.5 352 118.1 352 96c0-53-43-96-96-96s-96 43-96 96c0 22.1 7.5 42.5 20.1 58.8c10.7 13.8 19.9 29.6 19.9 47c0 29.9-24.3 54.2-54.2 54.2H112C50.1 256 0 306.1 0 368c0 20.9 13.4 38.7 32 45.3V464c0 26.5 21.5 48 48 48H432c26.5 0 48-21.5 48-48V413.3c18.6-6.6 32-24.4 32-45.3c0-61.9-50.1-112-112-112H366.2c-29.9 0-54.2-24.3-54.2-54.2zM416 416H96V400H416v16z'/%3E%3C/svg%3E"
    />

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Vue.js 3 -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <!-- FontAwesome Icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    />
    <!-- Google Fonts: Noto Sans TC -->
    <link
      href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap"
      rel="stylesheet"
    />
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&display=swap"
      rel="stylesheet"
    />

    <style>
      body {
        font-family: "Noto Sans TC", sans-serif;
        -webkit-tap-highlight-color: transparent;
      }

      .font-serif {
        font-family: "Playfair Display", serif;
      }

      .scrollbar-hide::-webkit-scrollbar {
        display: none;
      }

      .scrollbar-hide {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      @keyframes popup {
        0% {
          transform: scale(0.5) rotate(-10deg);
          opacity: 0;
        }
        60% {
          transform: scale(1.1) rotate(5deg);
        }
        100% {
          transform: scale(1) rotate(0);
          opacity: 1;
        }
      }

      .animate-popup {
        animation: popup 0.5s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.4s ease-out;
      }

      .inner-shadow {
        box-shadow: inset 0 2px 4px 0 rgba(0, 0, 0, 0.05);
      }

      @keyframes pop {
        0% {
          transform: scale(0.8);
          opacity: 0;
        }
        100% {
          transform: scale(1);
          opacity: 1;
        }
      }

      .animate-pop {
        animation: pop 0.2s ease-out;
      }
    </style>
  </head>
  <body class="bg-stone-50 min-h-screen">
    <div id="app"></div>

    <!-- Vue Templates -->
    <script type="text/x-template" id="stamp-view-template">
      <div class="px-6 pt-8 pb-36 animate-fade-in">
        <div class="text-center space-y-1 mb-6">
          <h2 class="text-stone-400 text-xs tracking-[0.2em] uppercase">KIDS REWARDS</h2>
          <h1 class="text-3xl font-serif text-stone-800 tracking-wide">ÈõÜÈªûÂç°</h1>
        </div>

        <div v-if="childrenList.length > 0" class="flex gap-2 mt-3 overflow-x-auto pb-2 scrollbar-hide mb-6">
          <button
            v-for="child in childrenList"
            :key="child.name"
            @click="$emit('update:searchName', child.name)"
            :class="[
              'whitespace-nowrap px-4 py-1.5 rounded-full text-sm font-medium transition-all',
              searchName === child.name
                ? getTheme(child.theme).bg + ' text-white shadow-md'
                : 'bg-white border border-stone-200 text-stone-500 hover:bg-stone-50',
            ]"
          >
            {{ child.name }}
          </button>
        </div>

        <div v-if="isCardVisible" class="flex-1 flex flex-col items-center space-y-8 w-full max-w-sm mx-auto relative z-10">
          <div class="w-full bg-white rounded-3xl p-6 shadow-xl shadow-stone-200/50 ring-1 ring-stone-100 relative overflow-hidden transition-all duration-500">
            <div v-if="currentBgUrl" class="absolute inset-0 bg-cover bg-center opacity-40" :style="{ backgroundImage: 'url(' + currentBgUrl + ')' }"></div>
            <div v-if="currentBgUrl" class="absolute inset-0 bg-gradient-to-b from-white/70 to-white/95"></div>
            <div v-else :class="'absolute top-0 left-0 right-0 h-32 opacity-10 ' + currentTheme.bg"></div>

            <div class="flex justify-between items-end mb-8 relative z-10">
              <div>
                <p class="text-stone-400 text-xs mb-1 font-bold tracking-wider">NAME</p>
                <p class="text-2xl font-bold text-stone-800 font-serif border-b-2 border-stone-100 pb-1 min-w-[100px]">
                  {{ searchName }}
                </p>
              </div>
              <div class="text-right">
                <p class="text-stone-400 text-xs mb-1 font-bold tracking-wider">REWARDS</p>
                <div :class="'flex items-center justify-end gap-1 ' + currentTheme.text">
                  <i class="fa-solid fa-gift"></i>
                  <span class="text-3xl font-bold leading-none">{{ stats.rewards }}</span>
                </div>
                <div class="mt-3">
                  <p class="text-center text-stone-400 text-xs mb-2">
                    ÈÇÑÂ∑Æ
                    <span :class="currentTheme.text + ' font-bold text-base mx-1'">{{ 10 - stats.currentCard }}</span>
                    Èªû
                  </p>
                  <div class="h-1.5 w-full bg-stone-100 rounded-full overflow-hidden">
                    <div :class="'h-full transition-all duration-1000 ease-out ' + currentTheme.bg" :style="{ width: progress + '%' }"></div>
                  </div>
                </div>
              </div>
            </div>

            <div class="grid grid-cols-5 gap-3 mb-8 relative z-10">
              <div
                v-for="i in 10"
                :key="i"
                :class="[
                  'aspect-square rounded-full flex items-center justify-center text-sm font-bold transition-all duration-500 overflow-hidden',
                  i - 1 < stats.currentCard
                    ? 'bg-white ' + currentTheme.text + ' shadow-md scale-100'
                    : 'bg-stone-100 text-stone-300 scale-90 inner-shadow',
                ]"
              >
                <template v-if="i - 1 < stats.currentCard">
                  <img v-if="currentStamp?.startsWith('http')" :src="currentStamp" class="w-full h-full object-contain" />
                  <span v-else-if="currentStamp" class="text-lg">{{ currentStamp }}</span>
                  <i v-else class="fa-solid fa-stamp"></i>
                </template>
                <template v-else>{{ i }}</template>
              </div>
            </div>
          </div>
        </div>

        <div v-else class="flex-1 flex flex-col items-center justify-center text-stone-300 space-y-4 min-h-[50vh]">
          <i class="fa-solid fa-user opacity-10" style="font-size: 80px;"></i>
          <p>Ë´ãÈÅ∏ÊìáÂêçÂñÆÈñãÂßãÈõÜÈªû</p>
        </div>

        <div v-if="isCardVisible" class="fixed bottom-32 left-0 right-0 flex justify-center z-50 pointer-events-none">
          <button
            @click="handleStamp"
            :disabled="stampAnimation !== null"
            :class="[
              'pointer-events-auto relative w-24 h-24 rounded-full shadow-2xl flex items-center justify-center transition-all text-white border-4 border-white ring-1 ring-stone-100 overflow-hidden',
              stampAnimation === 'stamping'
                ? 'scale-90 ' + currentTheme.bg
                : currentTheme.bg + ' hover:scale-105 hover:rotate-3 active:scale-90',
            ]"
          >
            <i v-if="stampAnimation === 'done'" class="fa-solid fa-check animate-bounce" style="font-size: 48px;"></i>
            <i v-else class="fa-solid fa-stamp" style="font-size: 48px;"></i>
            <span
              v-if="stampAnimation === 'stamping'"
              :class="'absolute inset-0 rounded-full border-4 opacity-0 animate-ping ' + currentTheme.text"
              style="border-color: currentColor"
            ></span>
          </button>
        </div>
      </div>
    </script>

    <script type="text/x-template" id="summary-view-template">
      <div class="px-6 pt-8 pb-36 animate-fade-in">
        <div class="flex justify-between items-center mb-6">
          <h1 class="text-2xl font-serif text-stone-800">ÈõÜÈªûÁãÄÊ≥Å</h1>
          <div class="flex gap-2">
            <button
              @click="$emit('add-new-profile')"
              class="px-4 py-2 bg-emerald-500 text-white rounded-full shadow-sm hover:bg-emerald-600 transition-all text-xs font-bold"
            >
              <i class="fa-solid fa-plus"></i> Êñ∞Â¢ûÂêçÂñÆ
            </button>
            <button
              @click="$emit('refresh-points')"
              class="p-2 bg-white rounded-full shadow-sm text-stone-400 hover:text-emerald-600 active:rotate-180 transition-all"
            >
              <i class="fa-solid fa-rotate"></i>
            </button>
          </div>
        </div>

        <div v-if="isLoading" class="flex justify-center py-10">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-emerald-600"></div>
        </div>

        <div v-else class="space-y-3">
          <div
            v-for="item in summary"
            :key="item.name"
            class="bg-white p-4 rounded-2xl shadow-sm border border-stone-100 flex items-center justify-between"
          >
            <div class="flex items-center gap-4 cursor-pointer" @click="$emit('select-user', item.name)">
              <div :class="'w-12 h-12 rounded-2xl flex items-center justify-center text-white text-lg font-bold shadow-md ' + item.theme.bg">
                <img v-if="item.bgUrl" :src="item.bgUrl" class="w-full h-full object-cover rounded-2xl" />
                <template v-else>{{ item.name.charAt(0) }}</template>
              </div>
              <div>
                <h3 class="font-bold text-stone-700 text-lg">{{ item.name }}</h3>
                <p class="text-xs text-stone-400">
                  Á∏ΩÈªûÊï∏:
                  <span class="text-stone-600 font-mono text-sm font-bold">{{ item.total }}</span>
                </p>
              </div>
            </div>
            <div class="flex gap-2 items-center">
              <button
                @click="$emit('edit-profile', item.name)"
                class="p-2 text-stone-400 hover:text-stone-600 transition-colors"
              >
                <i class="fa-solid fa-gear"></i>
              </button>
              <button
                @click="$emit('redeem', item.name, item.total)"
                class="px-4 py-2 bg-rose-50 text-rose-500 hover:bg-rose-100 rounded-xl text-xs font-bold border border-rose-100 transition-colors"
              >
                ÂÖåÊèõ
              </button>
            </div>
          </div>
        </div>
      </div>
    </script>

    <script type="text/x-template" id="settings-view-template">
      <div class="px-6 pt-8 pb-36 animate-fade-in">
        <h1 class="text-2xl font-serif text-stone-800 mb-6">Ë®≠ÂÆö</h1>
        <div class="bg-white p-6 rounded-3xl shadow-sm border border-stone-100 space-y-6">
          <div class="space-y-2">
            <label class="text-sm font-bold text-stone-500">Google Sheet (Points)</label>
            <input
              v-model="config.pointsSheetUrl"
              type="text"
              class="w-full text-xs p-3 bg-stone-50 rounded-xl text-stone-600"
            />
          </div>
          <div class="space-y-2">
            <label class="text-sm font-bold text-stone-500">Google Sheet (Profiles)</label>
            <input
              v-model="config.profilesSheetUrl"
              type="text"
              class="w-full text-xs p-3 bg-stone-50 rounded-xl text-stone-600"
            />
          </div>
          <button
            @click="saveSettings"
            class="w-full py-4 bg-stone-800 text-white font-bold rounded-xl"
          >
            ÂÑ≤Â≠òË®≠ÂÆö
          </button>
        </div>
      </div>
    </script>

    <script type="text/x-template" id="redeem-modal-template">
      <Teleport to="body">
        <div
          v-if="visible"
          class="fixed inset-0 z-[70] flex items-center justify-center bg-black/30 backdrop-blur-sm"
          @click.self="close"
        >
          <div class="bg-white rounded-2xl w-full max-w-xs p-6 animate-pop shadow-2xl mx-4">
            <h3 class="text-lg font-bold text-center mb-4">ÂÖåÊèõÊâ£Èªû ({{ name }})</h3>
            <p class="text-center text-stone-500 text-sm mb-6">ÁõÆÂâçÈªûÊï∏: {{ currentPoints }}</p>

            <div class="flex items-center justify-center space-x-4 mb-8">
              <button
                @click="decreaseCount"
                class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-xl font-bold hover:bg-stone-200 transition-colors"
              >
                -
              </button>
              <input
                v-model.number="redeemCount"
                type="number"
                :min="1"
                :max="currentPoints"
                class="w-16 text-center text-xl font-bold outline-none border-b-2 border-emerald-200 focus:border-emerald-500"
              />
              <button
                @click="increaseCount"
                class="w-10 h-10 rounded-full bg-stone-100 flex items-center justify-center text-xl font-bold hover:bg-stone-200 transition-colors"
              >
                +
              </button>
            </div>

            <div class="flex space-x-3">
              <button
                @click="close"
                class="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-500 hover:bg-stone-200 transition-colors"
              >
                ÂèñÊ∂à
              </button>
              <button
                @click="confirm"
                class="flex-1 py-3 bg-emerald-500 text-white rounded-xl font-bold shadow-lg shadow-emerald-200 hover:bg-emerald-600 transition-colors"
              >
                Á¢∫Ë™çÊâ£Èªû
              </button>
            </div>
          </div>
        </div>
      </Teleport>
    </script>

    <script type="text/x-template" id="edit-profile-modal-template">
      <Teleport to="body">
        <div
          v-if="visible"
          class="fixed inset-0 z-[70] flex items-center justify-center bg-black/30 backdrop-blur-sm"
          @click.self="close"
        >
          <div class="bg-white rounded-2xl w-full max-w-md p-6 animate-pop shadow-2xl mx-4 max-h-[90vh] overflow-y-auto">
            <h3 class="text-lg font-bold text-center mb-6">{{ isNewProfile ? 'Êñ∞Â¢ûÂêçÂñÆ' : 'Á∑®ËºØÂêçÂñÆ' }}</h3>

            <div class="space-y-6">
              <div class="space-y-2">
                <label class="text-xs font-bold text-stone-400 tracking-wider">ÂßìÂêç</label>
                <input
                  v-model="formState.name"
                  type="text"
                  class="block w-full p-4 bg-stone-50 rounded-2xl border-none focus:ring-2 focus:ring-stone-200 text-lg text-stone-800"
                  placeholder="‰æãÂ¶Ç: Anna"
                />
              </div>

              <div class="space-y-2">
                <label class="text-xs font-bold text-stone-400 tracking-wider flex items-center gap-2">
                  <i class="fa-solid fa-image"></i> ÂúñÁâáÁ∂≤ÂùÄ
                </label>
                <input
                  v-model="formState.bgUrl"
                  type="text"
                  class="block w-full p-3 bg-stone-50 rounded-2xl border-none text-sm text-stone-600"
                  placeholder="https://..."
                />
              </div>

              <div class="space-y-2">
                <label class="text-xs font-bold text-stone-400 tracking-wider flex items-center gap-2">
                  <i class="fa-solid fa-stamp"></i> Ëá™Ë®ÇÂç∞Á´† (ÂúñÁâáÁ∂≤ÂùÄÊàñ Emoji)
                </label>
                <input
                  v-model="formState.stamp"
                  type="text"
                  class="block w-full p-3 bg-stone-50 rounded-2xl border-none text-sm text-stone-600"
                  placeholder="‰æãÂ¶Ç: üêª Êàñ https://..."
                />
              </div>

              <div class="space-y-3">
                <label class="text-xs font-bold text-stone-400 tracking-wider flex items-center gap-2">
                  <i class="fa-solid fa-palette"></i> È¢®Ê†º
                </label>
                <div class="grid grid-cols-6 gap-2">
                  <button
                    v-for="[key, theme] in Object.entries(CARD_THEMES).filter(([k]) => k !== 'default')"
                    :key="key"
                    type="button"
                    @click="formState.theme = key"
                    :class="[
                      'aspect-square rounded-xl flex flex-col items-center justify-center gap-1 border-2 transition-all',
                      formState.theme === key
                        ? 'border-stone-800 bg-stone-50 scale-105'
                        : 'border-transparent hover:bg-stone-50',
                    ]"
                  >
                    <div :class="'w-5 h-5 rounded-full ' + theme.bg"></div>
                    <span class="text-[9px] text-stone-500">{{ theme.name }}</span>
                  </button>
                </div>
              </div>

              <div :class="'p-4 rounded-xl ' + previewTheme.accent + ' flex items-center justify-center relative overflow-hidden'">
                <div
                  v-if="formState.bgUrl"
                  class="absolute inset-0 bg-cover bg-center opacity-40"
                  :style="{ backgroundImage: 'url(' + formState.bgUrl + ')' }"
                ></div>
                <span :class="'text-sm font-bold ' + previewTheme.text + ' relative z-10'">
                  {{ formState.name || 'È†êË¶Ω' }}
                </span>
              </div>

              <div class="flex space-x-3">
                <button
                  @click="close"
                  class="flex-1 py-3 bg-stone-100 rounded-xl font-bold text-stone-500 hover:bg-stone-200 transition-colors"
                >
                  ÂèñÊ∂à
                </button>
                <button
                  @click="save"
                  class="flex-1 py-3 bg-stone-800 text-white rounded-xl font-bold shadow-lg shadow-stone-200 hover:bg-stone-700 transition-colors"
                >
                  {{ isNewProfile ? 'Êñ∞Â¢û' : 'ÂÑ≤Â≠ò/Êõ¥Êñ∞' }}
                </button>
              </div>
            </div>
          </div>
        </div>
      </Teleport>
    </script>

    <script type="text/x-template" id="app-template">
      <div
        id="app"
        class="max-w-md mx-auto h-screen bg-stone-50 shadow-2xl relative flex flex-col overflow-hidden ring-1 ring-stone-900/5"
      >
        <main id="main-content" class="flex-1 overflow-y-auto scrollbar-hide relative z-0">
          <StampView
            v-if="activeTab === 'stamp'"
            :searchName="searchName"
            :childrenList="childrenList"
            :transactions="transactions"
            :stampAnimation="stampAnimation"
            @update:searchName="searchName = $event"
            @update:stampAnimation="stampAnimation = $event"
            @add-transaction="addTransaction"
          />
          <SummaryView
            v-else-if="activeTab === 'summary'"
            :transactions="transactions"
            :childrenList="childrenList"
            :isLoading="isLoading"
            @refresh-points="refreshPoints"
            @select-user="selectUser"
            @redeem="showRedeemModal"
            @edit-profile="showEditProfileModal"
            @add-new-profile="showAddProfileModal"
          />
          <SettingsView
            v-else-if="activeTab === 'settings'"
            :config="config"
            @save-config="saveConfig"
          />
        </main>

        <nav class="absolute bottom-0 left-0 right-0 bg-white/95 backdrop-blur-xl border-t border-stone-100 px-6 py-4 pb-8 flex justify-between items-center z-50 shadow-[0_-10px_40px_-15px_rgba(0,0,0,0.1)]">
          <button
            v-for="tab in tabs"
            :key="tab.id"
            @click="switchTab(tab.id)"
            :class="[
              'flex flex-col items-center gap-1.5 transition-all p-2 rounded-xl',
              activeTab === tab.id
                ? 'text-stone-800 bg-stone-100'
                : 'text-stone-400 hover:text-stone-600',
            ]"
          >
            <i :class="['fa-solid', 'fa-' + tab.icon]" style="font-size: 24px;"></i>
            <span class="text-[10px] font-bold tracking-widest">{{ tab.label }}</span>
          </button>
        </nav>

        <Teleport to="body">
          <div
            v-if="stampAnimation === 'done'"
            class="fixed inset-0 z-[60] flex items-center justify-center"
          >
            <div class="bg-white/95 backdrop-blur-sm px-10 py-8 rounded-[2rem] shadow-2xl animate-popup flex flex-col items-center border border-stone-100">
              <div class="mb-4 rotate-[-12deg]">
                <i class="fa-solid fa-stamp" style="font-size: 64px;"></i>
              </div>
              <p class="text-stone-800 text-lg font-bold tracking-wide">ÈõÜÈªûÊàêÂäüÔºÅ</p>
            </div>
          </div>
        </Teleport>

        <RedeemModal
          :visible="redeemModal.visible"
          :name="redeemModal.name"
          :currentPoints="redeemModal.currentPoints"
          @close="closeRedeemModal"
          @confirm="confirmRedeem"
        />

        <EditProfileModal
          :visible="editProfileModal.visible"
          :profileName="editProfileModal.profileName"
          :childrenList="childrenList"
          @close="closeEditProfileModal"
          @save="saveProfile"
        />

        <Teleport to="body">
          <div
            v-if="successModal.visible"
            class="fixed inset-0 z-[80] flex items-center justify-center"
          >
            <div class="bg-white/95 backdrop-blur-sm px-10 py-8 rounded-[2rem] shadow-2xl animate-popup flex flex-col items-center border border-stone-100">
              <div class="mb-4 text-emerald-500">
                <i class="fa-solid fa-circle-check" style="font-size: 64px;"></i>
              </div>
              <p class="text-stone-800 text-lg font-bold tracking-wide">{{ successModal.message }}</p>
            </div>
          </div>
        </Teleport>
      </div>
    </script>

    <!-- JavaScript -->
    <script>
      const { createApp, ref, reactive, computed, watch, onMounted, Teleport } =
        Vue;

      // ==================== CONFIG ====================
      const CONFIG = {
        pointsSheetUrl:
          "https://docs.google.com/spreadsheets/d/1VwiAVYi-LpIIG_J7LHUZohQzSKvCi4WLSl6VrqydsHs/export?format=csv",
        profilesSheetUrl:
          "https://docs.google.com/spreadsheets/d/1eoUaZ8lWigOQoNb6AnlhDfnDNlQVkXpVstmeQUE0KVA/export?format=csv",
        webhookUrl:
          "https://hook.eu1.make.com/xibpn714zhigzokihu4jme8if8g5tqe2",
        webhookAddChildUrl:
          "https://hook.eu1.make.com/fijzr7l2hs7y5h6msu322fy15tfm3l5v",
      };

      const CARD_THEMES = {
        matcha: {
          name: "ÊäπËå∂",
          bg: "bg-emerald-500",
          text: "text-emerald-600",
          accent: "bg-emerald-50",
        },
        sakura: {
          name: "Ê´ªËä±",
          bg: "bg-pink-400",
          text: "text-pink-500",
          accent: "bg-pink-50",
        },
        red: {
          name: "Á¥ÖË±Ü",
          bg: "bg-rose-500",
          text: "text-rose-600",
          accent: "bg-rose-50",
        },
        ocean: {
          name: "Êµ∑Ê¥ã",
          bg: "bg-blue-500",
          text: "text-blue-600",
          accent: "bg-blue-50",
        },
        ink: {
          name: "Â¢®Êüì",
          bg: "bg-slate-700",
          text: "text-slate-700",
          accent: "bg-slate-50",
        },
        gold: {
          name: "ÈáëÁÆî",
          bg: "bg-amber-500",
          text: "text-amber-600",
          accent: "bg-amber-50",
        },
        default: {
          name: "È†êË®≠",
          bg: "bg-stone-400",
          text: "text-stone-500",
          accent: "bg-stone-50",
        },
      };

      // ==================== UTILS ====================
      function parseCSVRow(row) {
        const result = [];
        let current = "";
        let inQuotes = false;
        for (let i = 0; i < row.length; i++) {
          const char = row[i];
          if (char === '"') {
            if (inQuotes && row[i + 1] === '"') {
              current += '"';
              i++;
            } else {
              inQuotes = !inQuotes;
            }
          } else if (char === "," && !inQuotes) {
            result.push(current);
            current = "";
          } else {
            current += char;
          }
        }
        result.push(current);
        return result;
      }

      function formatDate(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, "0");
        const day = String(date.getDate()).padStart(2, "0");
        const hours = String(date.getHours()).padStart(2, "0");
        const minutes = String(date.getMinutes()).padStart(2, "0");
        const seconds = String(date.getSeconds()).padStart(2, "0");
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
      }

      // ==================== API ====================
      async function fetchSheetData(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const csvText = await response.text();
          const rows = csvText
            .split("\n")
            .slice(1)
            .filter((r) => r.trim());

          const parsedData = rows
            .map((row) => {
              const cols = parseCSVRow(row);
              if (cols.length < 2) return null;

              let name = cols[0];
              let timestamp = cols[1];
              let points = "1";

              if (cols.length >= 3) {
                const parsedCount = parseInt(cols[2]);
                if (!isNaN(parsedCount)) points = String(parsedCount);
              }

              // ËôïÁêÜÂèØËÉΩÁöÑÊó•Êúü/ÂêçÁ®±Â∞çË™ø
              if (!isNaN(Date.parse(name)) && name.length > 10) {
                [name, timestamp] = [timestamp, name];
              }

              // ÈÅéÊøæÁÑ°ÊïàÂêçÁ®±
              if (
                !name ||
                ["TRUE", "FALSE", "NAME", "ÂêçÁ®±"].includes(name.toUpperCase())
              ) {
                return null;
              }

              return { name, timestamp, points, type: "add" };
            })
            .filter(Boolean);

          return parsedData;
        } catch (error) {
          console.error("ËºâÂÖ•ÈõÜÈªûË≥áÊñôÂ§±Êïó:", error);
          return [];
        }
      }

      async function fetchProfilesData(url) {
        try {
          const response = await fetch(url);
          if (!response.ok) throw new Error(`HTTP ${response.status}`);
          const csvText = await response.text();
          const rows = csvText.split("\n").filter((r) => r.trim());

          // Ê™¢Êü•Á¨¨‰∏ÄË°åÊòØÂê¶ÁÇ∫Ê®ôÈ°å
          let startIdx =
            rows[0]?.toLowerCase().includes("name") || rows[0]?.includes("ÂßìÂêç")
              ? 1
              : 0;

          const profilesMap = new Map();
          for (let i = startIdx; i < rows.length; i++) {
            const cols = parseCSVRow(rows[i]);
            if (cols.length === 0) continue;

            const name = cols[0];
            const bgUrl = cols[1]?.includes("http") ? cols[1] : "";
            const theme = cols[2] || cols[1] || "matcha";
            const stamp = cols[3] || "";

            if (name && !["TRUE", "FALSE"].includes(name.toUpperCase())) {
              profilesMap.set(name, {
                name,
                bgUrl,
                theme: theme.toLowerCase(),
                stamp,
              });
            }
          }
          return Array.from(profilesMap.values());
        } catch (error) {
          console.error("ËºâÂÖ•ÂêçÂñÆË≥áÊñôÂ§±Êïó:", error);
          return [];
        }
      }

      async function sendTransaction(type, name, points) {
        const timestamp = formatDate(new Date());
        const url = `${CONFIG.webhookUrl}?title=${encodeURIComponent(
          name
        )}&date=${encodeURIComponent(timestamp)}&redeem=${points}`;
        await fetch(url, { method: "GET" });
      }

      async function sendAddChild(name, theme, bgUrl, stamp) {
        const url = `${CONFIG.webhookAddChildUrl}?name=${encodeURIComponent(
          name
        )}&img=${encodeURIComponent(bgUrl)}&color=${encodeURIComponent(
          theme
        )}&stamp=${encodeURIComponent(stamp)}`;
        await fetch(url, { method: "GET" });
      }

      // ==================== COMPONENTS ====================
      const StampView = {
        template: "#stamp-view-template",
        props: ["searchName", "childrenList", "transactions", "stampAnimation"],
        emits: [
          "update:searchName",
          "update:stampAnimation",
          "add-transaction",
        ],
        setup(props, { emit }) {
          const getTheme = (key) => CARD_THEMES[key] || CARD_THEMES.default;

          const currentChild = computed(() => {
            return props.childrenList.find((c) => c.name === props.searchName);
          });

          const currentTheme = computed(() =>
            getTheme(currentChild.value?.theme)
          );
          const currentBgUrl = computed(() => currentChild.value?.bgUrl || "");
          const currentStamp = computed(() => currentChild.value?.stamp || "");

          const stats = computed(() => {
            const filtered = props.transactions.filter(
              (t) => t.name && t.name === props.searchName
            );
            const total = filtered.reduce(
              (sum, t) => sum + parseInt(t.points || 0),
              0
            );
            const rewards = Math.floor(total / 10);
            const current = total % 10;
            return { total, rewards, currentCard: current };
          });

          const progress = computed(() => (stats.value.currentCard / 10) * 100);
          const isCardVisible = computed(
            () => props.searchName && currentChild.value
          );

          const checkAdminPassword = () => {
            const saved = localStorage.getItem("admin-verified");
            if (saved === "true") {
              return true;
            }
            const password = prompt("Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂì°ÂØÜÁ¢ºÔºö");
            if (password === "admin") {
              localStorage.setItem("admin-verified", "true");
              return true;
            } else {
              alert("ÂØÜÁ¢ºÈåØË™§");
              return false;
            }
          };

          const handleStamp = async () => {
            if (props.stampAnimation !== null) return;
            if (!checkAdminPassword()) return;
            emit("update:stampAnimation", "stamping");
            emit("add-transaction", props.searchName);
            setTimeout(() => {
              emit("update:stampAnimation", "done");
              setTimeout(() => {
                emit("update:stampAnimation", null);
              }, 1000);
            }, 200);
          };

          return {
            getTheme,
            currentTheme,
            currentBgUrl,
            currentStamp,
            stats,
            progress,
            isCardVisible,
            handleStamp,
          };
        },
      };

      const SummaryView = {
        template: "#summary-view-template",
        props: ["transactions", "childrenList", "isLoading"],
        emits: [
          "refresh-points",
          "select-user",
          "redeem",
          "edit-profile",
          "add-new-profile",
        ],
        setup(props) {
          const getTheme = (key) => CARD_THEMES[key] || CARD_THEMES.default;

          const summary = computed(() => {
            // ÂÖàË®àÁÆóÊØèÂÄã‰∫∫ÁöÑÈªûÊï∏
            const nameMap = {};
            props.transactions.forEach((t) => {
              if (!t.name || !t.name.trim()) return;
              const pts = parseInt(t.points || 0);
              if (!nameMap[t.name]) nameMap[t.name] = 0;
              nameMap[t.name] += pts;
            });

            // È°ØÁ§∫ÊâÄÊúâÂú®ÂêçÂñÆÂÖßÁöÑ‰∫∫ÔºåÂåÖÊã¨ÈªûÊï∏ÁÇ∫ 0 ÁöÑ
            return props.childrenList
              .map((child) => {
                const total = nameMap[child.name] || 0;
                return {
                  name: child.name,
                  total,
                  theme: getTheme(child.theme),
                  bgUrl: child.bgUrl || "",
                };
              })
              .sort((a, b) => b.total - a.total);
          });

          return { summary, getTheme };
        },
      };

      const SettingsView = {
        template: "#settings-view-template",
        props: ["config"],
        emits: ["save-config"],
        setup(props, { emit }) {
          const config = reactive({ ...props.config });

          const saveSettings = () => {
            emit("save-config", config);
            alert("Ë®≠ÂÆöÂ∑≤ÂÑ≤Â≠ò");
          };

          return { config, saveSettings };
        },
      };

      const RedeemModal = {
        template: "#redeem-modal-template",
        props: ["visible", "name", "currentPoints"],
        emits: ["close", "confirm"],
        setup(props, { emit }) {
          const redeemCount = ref(10);

          watch(
            () => props.visible,
            (newVal) => {
              if (newVal) redeemCount.value = Math.min(10, props.currentPoints);
            }
          );

          const close = () => emit("close");

          const confirm = () => {
            if (redeemCount.value > props.currentPoints) {
              alert(`ÂÖåÊèõÈªûÊï∏‰∏çËÉΩË∂ÖÈÅéÁõÆÂâçÊìÅÊúâÁöÑ ${props.currentPoints} Èªû`);
              return;
            }
            if (redeemCount.value < 1) {
              alert("ÂÖåÊèõÈªûÊï∏ÂøÖÈ†àËá≥Â∞ëÁÇ∫ 1 Èªû");
              return;
            }
            emit("confirm", redeemCount.value);
          };

          const increaseCount = () => {
            if (redeemCount.value < props.currentPoints) {
              redeemCount.value++;
            }
          };

          const decreaseCount = () => {
            if (redeemCount.value > 1) {
              redeemCount.value--;
            }
          };

          return { redeemCount, close, confirm, increaseCount, decreaseCount };
        },
        components: { Teleport },
      };

      const EditProfileModal = {
        template: "#edit-profile-modal-template",
        props: ["visible", "profileName", "childrenList"],
        emits: ["close", "save"],
        setup(props, { emit }) {
          const formState = reactive({
            name: "",
            theme: "matcha",
            bgUrl: "",
            stamp: "",
          });

          const isNewProfile = computed(() => !props.profileName);
          const previewTheme = computed(
            () => CARD_THEMES[formState.theme] || CARD_THEMES.default
          );

          watch(
            () => props.visible,
            (newVal) => {
              if (newVal) {
                if (props.profileName) {
                  const child = props.childrenList.find(
                    (c) => c.name === props.profileName
                  );
                  if (child) {
                    formState.name = child.name;
                    formState.theme = child.theme || "matcha";
                    formState.bgUrl = child.bgUrl || "";
                    formState.stamp = child.stamp || "";
                  }
                } else {
                  formState.name = "";
                  formState.theme = "matcha";
                  formState.bgUrl = "";
                  formState.stamp = "";
                }
              }
            }
          );

          const close = () => emit("close");

          const save = async () => {
            if (!formState.name.trim()) {
              alert("Ë´ãËº∏ÂÖ•ÂßìÂêç");
              return;
            }
            emit("save", {
              name: formState.name,
              theme: formState.theme,
              bgUrl: formState.bgUrl,
              stamp: formState.stamp,
            });
          };

          return {
            formState,
            isNewProfile,
            previewTheme,
            close,
            save,
            CARD_THEMES,
          };
        },
        components: { Teleport },
      };

      // ==================== APP ====================
      const App = {
        template: "#app-template",
        setup() {
          const activeTab = ref("stamp");
          const searchName = ref("");
          const transactions = ref([]);
          const childrenList = ref([]);
          const stampAnimation = ref(null);
          const isLoading = ref(false);
          const config = reactive({ ...CONFIG });

          const redeemModal = reactive({
            visible: false,
            name: "",
            currentPoints: 0,
          });

          const editProfileModal = reactive({
            visible: false,
            profileName: "",
          });

          const successModal = reactive({
            visible: false,
            message: "",
          });

          const tabs = [
            { id: "stamp", label: "ÈõÜÈªûÂç°", icon: "stamp" },
            { id: "summary", label: "ÁãÄÊ≥Å", icon: "chart-simple" },
            { id: "settings", label: "Ë®≠ÂÆö", icon: "gear" },
          ];

          const loadData = async () => {
            isLoading.value = true;
            try {
              const timestamp = Date.now();
              const pointsUrl =
                config.pointsSheetUrl +
                (config.pointsSheetUrl.includes("?") ? "&" : "?") +
                "t=" +
                timestamp;
              const profilesUrl =
                config.profilesSheetUrl +
                (config.profilesSheetUrl.includes("?") ? "&" : "?") +
                "t=" +
                timestamp;

              const [pointsData, profilesData] = await Promise.all([
                fetchSheetData(pointsUrl),
                fetchProfilesData(profilesUrl),
              ]);
              transactions.value = pointsData;
              childrenList.value = profilesData;
            } catch (error) {
              console.error("ËºâÂÖ•Â§±Êïó:", error);
            } finally {
              isLoading.value = false;
            }
          };

          const addTransaction = async (name) => {
            try {
              await sendTransaction("add", name, 1);
              transactions.value.push({
                type: "add",
                name,
                points: "1",
                timestamp: formatDate(new Date()),
              });
            } catch (error) {
              console.error("ÈõÜÈªûÂ§±Êïó:", error);
            }
          };

          const refreshProfiles = async () => {
            try {
              const timestamp = Date.now();
              const profilesUrl =
                config.profilesSheetUrl +
                (config.profilesSheetUrl.includes("?") ? "&" : "?") +
                "t=" +
                timestamp;
              const profilesData = await fetchProfilesData(profilesUrl);
              childrenList.value = profilesData;
            } catch (error) {
              console.error("ÈáçÊï¥Â§±Êïó:", error);
            }
          };

          const refreshPoints = async () => {
            isLoading.value = true;
            try {
              const timestamp = Date.now();
              const pointsUrl =
                config.pointsSheetUrl +
                (config.pointsSheetUrl.includes("?") ? "&" : "?") +
                "t=" +
                timestamp;
              const pointsData = await fetchSheetData(pointsUrl);
              transactions.value = pointsData;
            } catch (error) {
              console.error("ÈáçÊï¥Â§±Êïó:", error);
            } finally {
              isLoading.value = false;
            }
          };

          const setSearchName = (name) => {
            searchName.value = name;
            activeTab.value = "stamp";
          };

          const selectUser = (name) => {
            searchName.value = name;
            activeTab.value = "stamp";
          };

          const showRedeemModal = (name, points) => {
            redeemModal.name = name;
            redeemModal.currentPoints = points;
            redeemModal.visible = true;
          };

          const showSuccessModal = (message) => {
            successModal.message = message;
            successModal.visible = true;
            setTimeout(() => {
              successModal.visible = false;
            }, 500);
          };

          const closeRedeemModal = () => {
            redeemModal.visible = false;
          };

          const confirmRedeem = async (count) => {
            const saved = localStorage.getItem("admin-verified");
            let isVerified = saved === "true";

            if (!isVerified) {
              const password = prompt("Ë´ãËº∏ÂÖ•ÁÆ°ÁêÜÂì°ÂØÜÁ¢ºÔºö");
              if (password === "admin") {
                localStorage.setItem("admin-verified", "true");
                isVerified = true;
              } else {
                alert("ÂØÜÁ¢ºÈåØË™§");
                closeRedeemModal();
                return;
              }
            }

            try {
              await sendTransaction("redeem", redeemModal.name, -count);
              transactions.value.push({
                type: "redeem",
                name: redeemModal.name,
                points: String(-count),
                timestamp: formatDate(new Date()),
              });
              closeRedeemModal();
              showSuccessModal(`ÊàêÂäüÂÖåÊèõ ${count} Èªû`);
            } catch (error) {
              alert("ÂÖåÊèõÂ§±Êïó: " + error.message);
            }
          };

          const showEditProfileModal = (name) => {
            editProfileModal.profileName = name;
            editProfileModal.visible = true;
          };

          const showAddProfileModal = () => {
            editProfileModal.profileName = "";
            editProfileModal.visible = true;
          };

          const closeEditProfileModal = () => {
            editProfileModal.visible = false;
          };

          const saveProfile = async (profileData) => {
            try {
              await sendAddChild(
                profileData.name,
                profileData.theme,
                profileData.bgUrl,
                profileData.stamp
              );
              closeEditProfileModal();
              showSuccessModal("Â∑≤ÈÄÅÂá∫ÔºåË´ãÁ®çÂæåÈáçÊñ∞Êï¥ÁêÜÂêçÂñÆ");
            } catch (error) {
              alert("ÈÄÅÂá∫Â§±Êïó: " + error.message);
            }
          };

          const saveConfig = (newConfig) => {
            Object.assign(config, newConfig);
            localStorage.setItem("app-config", JSON.stringify(config));
          };

          const switchTab = (tabId) => {
            activeTab.value = tabId;
          };

          // Áõ£ËÅΩ searchName ËÆäÂåñÔºåËá™ÂãïÂÑ≤Â≠ò
          watch(searchName, (newName) => {
            if (newName) {
              localStorage.setItem("last-search-name", newName);
            }
          });

          onMounted(() => {
            const saved = localStorage.getItem("app-config");
            if (saved) {
              try {
                Object.assign(config, JSON.parse(saved));
              } catch (e) {
                console.error("Ë®≠ÂÆöËºâÂÖ•Â§±Êïó:", e);
              }
            }

            // ËºâÂÖ•‰∏äÊ¨°ÊêúÂ∞ãÁöÑÂêçÂ≠ó
            const lastSearchName = localStorage.getItem("last-search-name");
            if (lastSearchName) {
              searchName.value = lastSearchName;
            }

            loadData();
          });

          return {
            activeTab,
            searchName,
            transactions,
            childrenList,
            stampAnimation,
            isLoading,
            config,
            redeemModal,
            editProfileModal,
            successModal,
            tabs,
            addTransaction,
            refreshProfiles,
            refreshPoints,
            setSearchName,
            selectUser,
            showRedeemModal,
            closeRedeemModal,
            confirmRedeem,
            showEditProfileModal,
            showAddProfileModal,
            closeEditProfileModal,
            saveProfile,
            showSuccessModal,
            saveConfig,
            switchTab,
          };
        },
        components: {
          StampView,
          SummaryView,
          SettingsView,
          RedeemModal,
          EditProfileModal,
        },
      };

      createApp(App).mount("#app");
    </script>
  </body>
</html>
